#!/bin/bash

# Script de teste para validar as corre√ß√µes de duplica√ß√£o de refei√ß√µes

echo "=========================================="
echo "TESTE: Corre√ß√£o de Duplica√ß√£o de Refei√ß√µes"
echo "=========================================="
echo ""

# Verificar se o servidor est√° rodando
echo "1. Verificando servidor..."
if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo "   ‚úÖ Servidor est√° rodando em http://localhost:8000"
else
    echo "   ‚ùå Servidor n√£o est√° respondendo"
    echo "   Execute: ./scripts/start_server.sh"
    exit 1
fi

echo ""
echo "2. Instru√ß√µes de teste manual:"
echo ""
echo "   A. GERAR NOVO PLANO:"
echo "      1. Acesse http://localhost:8000/home.html"
echo "      2. Fa√ßa login"
echo "      3. V√° para aba 'Profile'"
echo "      4. Preencha todos os dados obrigat√≥rios"
echo "      5. Clique em 'Gerar novo plano'"
echo "      6. Aguarde a gera√ß√£o (pode levar 1-2 minutos)"
echo ""
echo "   B. VERIFICAR ABA DAILY PLAN:"
echo "      1. Timeline deve mostrar para cada dia:"
echo "         ‚úÖ Hor√°rios em formato brasileiro (07h30, 12h00, 19h00)"
echo "         ‚úÖ Checks de glicemia em portugu√™s:"
echo "            - 'Glicemia em Jejum'"
echo "            - 'Glicemia Pr√©-Prandial'"
echo "         ‚úÖ Refei√ß√µes com descri√ß√µes (n√£o 'Veja detalhes na aba Nutri√ß√£o')"
echo "         ‚úÖ Atividades em portugu√™s:"
echo "            - 'Caminhada Leve'"
echo "            - 'Caminhada Moderada'"
echo "            - 'Alongamento Leve'"
echo "         ‚ùå N√ÉO deve ter eventos com 'Breakfast', 'Lunch', 'Dinner'"
echo "         ‚ùå N√ÉO deve ter hor√°rios em formato AM/PM"
echo ""
echo "   C. VERIFICAR ABA NUTRITION:"
echo "      1. Deve mostrar aproximadamente 35 refei√ß√µes"
echo "      2. Cada refei√ß√£o deve ter:"
echo "         ‚úÖ Dia da semana (SEGUNDA-FEIRA, TER√áA-FEIRA, etc.)"
echo "         ‚úÖ Tipo (Caf√© da manh√£, Almo√ßo, Jantar)"
echo "         ‚úÖ Nome da refei√ß√£o"
echo "         ‚úÖ Descri√ß√£o detalhada"
echo "         ‚úÖ Informa√ß√£o nutricional completa"
echo "      3. Verifica√ß√µes:"
echo "         ‚ùå N√ÉO deve haver refei√ß√µes duplicadas"
echo "         ‚ùå N√ÉO deve haver refei√ß√µes sem detalhes"
echo "         ‚úÖ Total de refei√ß√µes: 21 (3 por dia √ó 7 dias) ou 35 (5 por dia √ó 7 dias)"
echo ""
echo "   D. VERIFICAR CONSOLE DO NAVEGADOR (F12):"
echo "      Deve aparecer:"
echo "      üìä Carregadas X refei√ß√µes detalhadas do array meals"
echo ""
echo "   E. VERIFICAR RESPONSE DA API:"
echo "      1. Abra DevTools (F12) ‚Üí Network"
echo "      2. Recarregue a p√°gina"
echo "      3. Encontre request para /api/users/{id}/plan"
echo "      4. Verificar JSON de resposta:"
echo "         ‚úÖ plan_json.meals deve ter ~35 refei√ß√µes detalhadas"
echo "         ‚úÖ plan_json.timeline deve ter ~63 eventos (21 glicemia + 21 refei√ß√µes + 21 atividades)"
echo "         ‚úÖ Cada evento de refei√ß√£o na timeline deve ter campo 'meal_ref'"
echo "         ‚úÖ meal_ref deve estar no formato 'DIA-TIPO' (ex: 'SEGUNDA-FEIRA-Caf√© da manh√£')"
echo "         ‚úÖ time_display deve estar em formato brasileiro (ex: '07h30')"
echo "         ‚úÖ Descri√ß√µes em portugu√™s (sem 'AM', 'PM', 'Breakfast', etc.)"
echo ""

echo "=========================================="
echo "MUDAN√áAS IMPLEMENTADAS"
echo "=========================================="
echo ""
echo "‚úÖ Prompt traduzido para portugu√™s"
echo "‚úÖ Formato de hora mudado para brasileiro (24h)"
echo "‚úÖ Timeline agora REFERENCIA meals via meal_ref"
echo "‚úÖ Timeline n√£o gera mais refei√ß√µes duplicadas"
echo "‚úÖ Aba Nutrition usa APENAS array meals"
echo "‚úÖ Aba Daily Plan enriquece timeline com dados de meals"
echo "‚úÖ Checks de glicemia em portugu√™s"
echo "‚úÖ Atividades em portugu√™s"
echo ""

echo "=========================================="
echo "ARQUIVOS MODIFICADOS"
echo "=========================================="
echo ""
echo "1. backend/meal_plan_rag.py"
echo "   - Task 8 (plan_json_task) reescrita"
echo "   - Linhas ~437-570"
echo ""
echo "2. frontend/home.html"
echo "   - loadNutritionPlan() simplificada"
echo "   - loadExistingPlan() com enriquecimento"
echo "   - loadPlan() com enriquecimento"
echo ""

echo "=========================================="
echo "TESTE AUTOM√ÅTICO (Opcional)"
echo "=========================================="
echo ""
echo "Para teste autom√°tico via API:"
echo ""
echo "# 1. Obter user_id"
echo "USER_ID=1  # Substitua pelo seu ID"
echo ""
echo "# 2. Gerar novo plano"
echo "curl -X POST http://localhost:8000/api/meal-plan/generate \\"
echo "  -H 'Content-Type: application/json' \\"
echo "  -d '{\"user_id\": '\$USER_ID'}' \\"
echo "  -o plan_response.json"
echo ""
echo "# 3. Verificar o JSON gerado"
echo "echo 'Verificando meals array...'"
echo "jq '.plan_json.meals | length' plan_response.json"
echo ""
echo "echo 'Verificando timeline array...'"
echo "jq '.plan_json.timeline | length' plan_response.json"
echo ""
echo "echo 'Verificando meal_ref na timeline...'"
echo "jq '.plan_json.timeline[] | select(.event_type == \"Meal\") | .meal_ref' plan_response.json | head -5"
echo ""
echo "echo 'Verificando formato de hora...'"
echo "jq '.plan_json.timeline[] | .time_display' plan_response.json | head -10"
echo ""

echo "=========================================="
echo "Para mais informa√ß√µes, consulte:"
echo "  CORRECAO_DUPLICACAO_REFEICOES.md"
echo "=========================================="
